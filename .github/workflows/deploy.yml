name: apply-pulumi
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  unit-tests:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '21'
      - run: npm ci
      - run: npm run test
  preview-base-dev:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '21'
      - run: npm ci
      - uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'
      - uses: pulumi/actions@v5
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        with:
          cloud-url: gs://pulumi-tactical-orbit-366415
          command: preview
          stack-name: dev
          work-dir: ./base
  apply-base-dev:
    needs: unit-tests
    uses: ./.github/workflows/apply.yml
    with:
      stack-name: dev
      work-dir: ./base
